<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Chat da Hamburgueria</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #1f2937, #020617);
        color: #f9fafb;
        margin: 0;
        padding: 24px;
        display: flex;
        justify-content: center;
      }

      .chat-wrapper {
        width: 100%;
        max-width: 420px;
        background: rgba(15, 23, 42, 0.95);
        border-radius: 24px;
        padding: 16px 16px 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        height: calc(100vh - 48px);
      }

      /* HEADER */

      .chat-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }

      .back-btn {
        width: 36px;
        height: 36px;
        border-radius: 999px;
        border: none;
        background: #020617;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: #e5e7eb;
        font-size: 18px;
      }

      .chat-title-area {
        display: flex;
        flex-direction: column;
      }

      .chat-title {
        font-weight: 600;
        font-size: 16px;
      }

      .chat-subtitle {
        font-size: 12px;
        color: #9ca3af;
      }

      /* INFO */

      #info {
        font-size: 12px;
        color: #9ca3af;
        margin-bottom: 8px;
      }

      /* LISTA DE MENSAGENS */

      #chat {
        flex: 1;
        overflow-y: auto;
        padding: 8px 4px;
        border-radius: 16px;
        background: #020617;
        border: 1px solid #111827;
      }

      .msg-row {
        display: flex;
        margin: 4px 0;
      }

      .msg-row.me {
        justify-content: flex-end;
      }

      .msg-row.system {
        justify-content: center;
      }

      .msg-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #fec89a;
        color: #111827;
        font-size: 14px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 8px;
        flex-shrink: 0;
      }

      .msg-row.me .msg-avatar {
        margin-right: 0;
        margin-left: 8px;
        background: #f97316;
        color: #111827;
      }

      .msg-bubble {
        max-width: 70%;
        padding: 6px 10px;
        border-radius: 16px;
        font-size: 13px;
        line-height: 1.35;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .msg-user {
        font-size: 11px;
        font-weight: 600;
        color: #e5e7eb;
      }

      .msg-text {
        word-wrap: break-word;
      }

      .msg-time {
        font-size: 10px;
        color: #9ca3af;
        align-self: flex-end;
      }

      .msg-row.other .msg-bubble {
        background: #111827;
        border-bottom-left-radius: 4px;
      }

      .msg-row.me .msg-bubble {
        background: linear-gradient(to right, #fb923c, #f97316);
        color: #111827;
        border-bottom-right-radius: 4px;
      }

      .msg-row.me .msg-user,
      .msg-row.me .msg-time {
        color: #111827cc;
      }

      .msg-row.system .msg-bubble {
        background: transparent;
        color: #facc15;
        font-size: 11px;
        padding: 2px 8px;
      }

      .msg-row.system .msg-time {
        display: none;
      }

      .msg-row.system .msg-user {
        display: none;
      }

      .msg-row.system .msg-text {
        text-align: center;
      }

      /* INPUT */

      .input-row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-top: 8px;
      }

      #msgInput {
        flex: 1;
        padding: 10px 14px;
        border-radius: 999px;
        border: 1px solid #111827;
        background: #020617;
        color: #f9fafb;
        outline: none;
        font-size: 14px;
      }

      #msgInput::placeholder {
        color: #6b7280;
      }

      #sendBtn {
        padding: 10px 16px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        background: linear-gradient(to right, #fb923c, #f97316);
        color: #111827;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
      }

      #sendBtn span {
        font-size: 16px;
      }

      #status {
        font-size: 11px;
        margin-top: 4px;
        color: #9ca3af;
        text-align: right;
      }
    </style>
  </head>
  <body>
    <div class="chat-wrapper">
      <div class="chat-header">
        <button class="back-btn" id="backButton" title="Voltar">
          ‚Üê
        </button>
        <div class="chat-title-area">
          <div class="chat-title">Chat com a galera</div>
          <div class="chat-subtitle">Converse com quem est√° na hamburgueria</div>
        </div>
      </div>

      <div id="info"></div>

      <div id="chat"></div>

      <div class="input-row">
        <input
          id="msgInput"
          placeholder="Digite sua mensagem e pressione Enter..."
          autocomplete="off"
        />
        <button id="sendBtn">
          <span>üí¨</span>
          <strong>Enviar</strong>
        </button>
      </div>

      <div id="status">Conectando ao chat...</div>

      <!-- Som de nova mensagem  -->
      <audio id="msgSound" preload="auto">
        <source src="/sons/notificacao.mp3" type="audio/mpeg" />
      </audio>
    </div>

    <script>
      const chat = document.getElementById("chat");
      const msgInput = document.getElementById("msgInput");
      const sendBtn = document.getElementById("sendBtn");
      const statusEl = document.getElementById("status");
      const infoEl = document.getElementById("info");
      const backButton = document.getElementById("backButton");
      const msgSound = document.getElementById("msgSound");

      // 1) Voltar para o in√≠cio
      backButton.addEventListener("click", () => {
        window.location.href = "/inicio.html";
      });

      // 2) Recupera dados da sess√£o salvos no login
      const sessionId = localStorage.getItem("sessionId");
      const mesaId = localStorage.getItem("mesaId");
      const nomeCliente = localStorage.getItem("nomeCliente");

      if (!sessionId || !mesaId || !nomeCliente) {
        alert("Sess√£o n√£o encontrada. Fa√ßa login novamente.");
        window.location.href = "/login.html";
      }

      // Nome exibido no chat 
      const myDisplayName =
        mesaId && mesaId !== "null" && mesaId !== "undefined"
          ? `${nomeCliente} (mesa ${mesaId})`
          : nomeCliente;

      infoEl.textContent = `Voc√™ √© "${nomeCliente}", mesa ${mesaId}.`;

      // 3) Abre conex√£o WebSocket j√° identificado
      const wsUrl =
        `ws://${location.hostname}:3000/chat` +
        `?sessionId=${encodeURIComponent(sessionId ?? "")}` +
        `&mesaId=${encodeURIComponent(mesaId ?? "")}` +
        `&nome=${encodeURIComponent(nomeCliente ?? "")}`;

      const socket = new WebSocket(wsUrl);

      socket.onopen = () => {
        statusEl.textContent = "Conectado ao chat.";
      };

      socket.onerror = () => {
        statusEl.textContent =
          "Erro ao conectar ao chat. Tente recarregar a p√°gina.";
      };

      socket.onclose = () => {
        statusEl.textContent = "Conex√£o encerrada.";
        sendBtn.disabled = true;
        msgInput.disabled = true;
      };

      function extractNameFromUserField(userField) {

        const idx = userField.indexOf(" (mesa");
        if (idx === -1) return userField;
        return userField.slice(0, idx);
      }

      function getInitials(name) {
        const parts = name
          .trim()
          .split(/\s+/)
          .filter(Boolean);
        if (parts.length === 0) return "?";
        if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
        return (
          parts[0].charAt(0).toUpperCase() +
          parts[parts.length - 1].charAt(0).toUpperCase()
        );
      }

      function addMessageToChat(data) {
        const isSystem = data.user === "Sistema";
        const isMe = data.user === myDisplayName;

        const row = document.createElement("div");
        row.classList.add("msg-row");
        if (isSystem) {
          row.classList.add("system");
        } else if (isMe) {
          row.classList.add("me");
        } else {
          row.classList.add("other");
        }

        const bubble = document.createElement("div");
        bubble.classList.add("msg-bubble");

        const textEl = document.createElement("div");
        textEl.classList.add("msg-text");
        textEl.textContent = data.text;

        const timeEl = document.createElement("div");
        timeEl.classList.add("msg-time");
        const dataHora = new Date(data.ts).toLocaleTimeString("pt-BR", {
          hour: "2-digit",
          minute: "2-digit",
        });
        timeEl.textContent = dataHora;

        if (isSystem) {
          bubble.appendChild(textEl);
          row.appendChild(bubble);
        } else {
          const userEl = document.createElement("div");
          userEl.classList.add("msg-user");
          userEl.textContent = data.user;

          bubble.appendChild(userEl);
          bubble.appendChild(textEl);
          bubble.appendChild(timeEl);

          const avatar = document.createElement("div");
          avatar.classList.add("msg-avatar");

          const nomePuro = extractNameFromUserField(data.user);
          avatar.textContent = getInitials(nomePuro);

          if (isMe) {
            row.appendChild(bubble);
            row.appendChild(avatar);
          } else {
            row.appendChild(avatar);
            row.appendChild(bubble);
          }
        }

        chat.appendChild(row);
        chat.scrollTop = chat.scrollHeight;

        // Som de nova mensagem 
        if (!isSystem && !isMe && msgSound) {
          try {
            msgSound.currentTime = 0;
            msgSound.play().catch(() => {});
          } catch (_) {}
        }
      }

      socket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          addMessageToChat(data);
        } catch (err) {
          console.error("Mensagem inv√°lida do servidor:", err);
        }
      };

      function enviarMensagem() {
        const texto = msgInput.value.trim();
        if (!texto) return;

        if (socket.readyState !== WebSocket.OPEN) {
          alert("Conex√£o com o chat n√£o est√° ativa.");
          return;
        }

        socket.send(JSON.stringify({ text: texto }));
        msgInput.value = "";
      }

      sendBtn.onclick = enviarMensagem;

      msgInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          enviarMensagem();
        }
      });
    </script>
  </body>
</html>
