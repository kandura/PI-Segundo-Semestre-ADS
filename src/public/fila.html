<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Fila de M√∫sicas - Hamburgueria Smash Bros</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        --bg: radial-gradient(circle at top, #1b2735 0%, #090a0f 45%, #000 100%);
        --card-bg: rgba(10, 10, 20, 0.9);
        --accent: #ffb342;
        --accent-soft: rgba(255, 179, 66, 0.15);
        --primary-text: #ffffff;
        --secondary-text: #a7b0c0;
        --border-subtle: rgba(255, 255, 255, 0.06);
        --danger: #ff4d4f;
        --success: #3fdca3;
        --shadow-soft: 0 18px 35px rgba(0, 0, 0, 0.8);
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        min-height: 100vh;
        margin: 0;
        font-family: system-ui, sans-serif;
        color: var(--primary-text);
        background: var(--bg);
        background-attachment: fixed;
      }

      .container {
        max-width: 960px;
        margin: 32px auto 100px;
        padding: 0 16px;
      }

      /* HEADER */
      .header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 24px;
      }

      .avatar {
        width: 44px;
        height: 44px;
        border-radius: 999px;
        background: linear-gradient(145deg, #4f8bff, #a279ff);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 18px;
        flex-shrink: 0;
      }

      .header-text { display: flex; flex-direction: column; gap: 2px; }

      .title { font-size: 20px; font-weight: 700; }
      .subtitle { font-size: 13px; color: var(--secondary-text); }

      /* FILA */
      .fila-lista { display: flex; flex-direction: column; gap: 12px; }

      .music-card {
        background: var(--card-bg);
        border-radius: 18px;
        padding: 14px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--border-subtle);
      }

      .music-info { display: flex; flex-direction: column; gap: 4px; }

      .music-title { font-size: 15px; font-weight: 600; }
      .music-artist { font-size: 12px; color: var(--secondary-text); }

      .status {
        font-size: 11px;
        font-weight: 600;
        padding: 6px 12px;
        border-radius: 999px;
      }

      .status.playing { background: rgba(63,220,163,.1); color: var(--success); border: 1px solid var(--success); }
      .status.next { background: rgba(255,179,66,.12); color: var(--accent); border: 1px solid var(--accent); }
      .status.waiting { background: rgba(255,255,255,.02); color: var(--secondary-text); border: 1px solid rgba(255,255,255,.05); }

      .empty-state {
        text-align: center;
        padding: 48px 16px;
        color: var(--secondary-text);
        font-size: 14px;
      }

      /* FOOTER NAV */
      .footer-nav {
        position: fixed;
        bottom: 0; left: 0; right: 0;
        height: 64px;
        background: rgba(0,0,0,.9);
        border-top: 1px solid rgba(255,255,255,.06);
        display: flex;
        justify-content: space-around;
        align-items: center;
      }

      .footer-btn {
        width: 52px; height: 52px;
        border-radius: 18px;
        border: 1px solid rgba(255,255,255,.13);
        display: flex; align-items: center; justify-content: center;
        font-size: 24px;
        background: rgba(10,10,20,.85);
        color: var(--secondary-text);
        cursor: pointer;
      }

      .footer-btn.active {
        background: var(--accent);
        border-color: var(--accent);
        color: #1a1210;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <header class="header">
        <div class="avatar" id="avatar">J</div>
        <div class="header-text">
          <div class="title">Fila de M√∫sicas</div>
          <div class="subtitle" id="subtitle"></div>
        </div>
      </header>

      <section>
        <div class="section-label">Pr√≥ximas m√∫sicas</div>
        <div id="fila" class="fila-lista"></div>
      </section>
    </div>

    <!-- FOOTER -->
    <footer class="footer-nav">
      <div class="footer-btn" onclick="location.href='/inicio.html'">üè†</div>
      <div class="footer-btn" onclick="location.href='/chat.html'">üí¨</div>
      <div class="footer-btn active" onclick="location.href='/fila.html'">üìÅ</div>
    </footer>

<script>
  /* ============ SESS√ÉO ============ */
  const nome = sessionStorage.getItem("nomeCliente");
  if (!nome) location.href = "/login.html";

  document.getElementById("avatar").textContent = nome[0].toUpperCase();
  const mesa = sessionStorage.getItem("mesaId") || "-";
  document.getElementById("subtitle").textContent =
    `Mesa ${mesa} ¬∑ Bem-vindo(a), ${nome}!`;

  /* ============ RENDERIZAR FILA ============ */
  function renderFila(pedidos) {
    const lista = document.getElementById("fila");
    lista.innerHTML = "";

    if (!pedidos || pedidos.length === 0) {
      lista.innerHTML = `
        <div class="empty-state">
          Nenhuma m√∫sica na fila üéß<br>
          Use a aba de pesquisa!
        </div>`;
      return;
    }

    pedidos.forEach((p, index) => {
      const status =
        index === 0 ? "playing" :
        index === 1 ? "next" :
        "waiting";

      const label =
        index === 0 ? "Tocando üéµ" :
        index === 1 ? "Pr√≥xima ‚è≥" :
        "Na fila";

      const card = document.createElement("div");
      card.className = "music-card";

      card.innerHTML = `
        <div class="music-info">
          <span class="music-title">${p.music.titulo}</span>
          <span class="music-artist">
            ${p.music.artista} ¬∑ Pedido por ${p.cliente.nome}
          </span>
        </div>
        <div class="status ${status}">${label}</div>
      `;

      lista.appendChild(card);
    });
  }

  /* ============ BUSCA API ============ */
  async function carregarFila() {
    try {
      const res = await fetch("/api/pedidos/fila");
      const dados = await res.json();
      renderFila(dados);
    } catch {
      document.getElementById("fila").innerHTML =
        `<div class="empty-state">Erro ao carregar a fila üò¢</div>`;
    }
  }

  carregarFila(); // carrega ao abrir

  /* ============ WEBSOCKET DA FILA ============ */
  const wsFila = new WebSocket(`ws://${location.host}/fila-ws`);

  wsFila.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.tipo === "atualizar-fila") {
      carregarFila(); // üî• atualiza√ß√£o instant√¢nea
    }
  };

  wsFila.onclose = () => {
    console.warn("WS da fila desconectado ‚Äî tentando reconectar...");
    setTimeout(() => location.reload(), 1500);
  };
</script>

  </body>
</html>
