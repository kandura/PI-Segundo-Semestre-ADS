<script>
  // ==========================
  //   DADOS DA SESS√ÉO
  // ==========================
  const nomeCliente = sessionStorage.getItem("nomeCliente") ?? "Cliente";
  const mesaId = Number(sessionStorage.getItem("mesaId"));

  if (!sessionStorage.getItem("nomeCliente") || !sessionStorage.getItem("mesaId")) {
    window.location.href = "/login.html";
  }

  document.getElementById("avatar").textContent = nomeCliente[0].toUpperCase();

  const input = document.getElementById("searchInput");
  const resultadosDiv = document.getElementById("resultados");

  let selectedTrack = null;

  // ==========================
  //   BUSCA NO SPOTIFY
  // ==========================
  async function buscar() {
    const q = input.value.trim();
    if (!q) return;

    resultadosDiv.innerHTML = "<p>‚è≥ Buscando m√∫sicas‚Ä¶</p>";

    try {
      const res = await fetch(`/api/spotify/search?q=${encodeURIComponent(q)}`);

      if (!res.ok) {
        const errText = await res.text().catch(() => "");
        console.error("Erro em /api/spotify/search:", errText);
        resultadosDiv.innerHTML = "<p>Erro ao buscar m√∫sicas üòï</p>";
        return;
      }

      const data = await res.json();
      renderResultados(data);
    } catch (err) {
      console.error("Erro inesperado ao buscar m√∫sicas:", err);
      resultadosDiv.innerHTML = "<p>Erro inesperado na busca üòï</p>";
    }
  }

  function renderResultados(lista) {
    resultadosDiv.innerHTML = "";

    if (!lista || lista.length === 0) {
      resultadosDiv.innerHTML = "<p>Nada encontrado üòï</p>";
      return;
    }

    lista.forEach((m) => {
      const card = document.createElement("div");
      card.className = "music-card";

      const trackObj = {
        spotifyId: m.spotifyId,
        spotifyUri: m.spotifyUri,
        title: m.title,
        artists: m.artists,
        album: m.album,
        coverUrl: m.coverUrl ?? "",
        durationMs: m.durationMs,
      };

      const coverSrc = trackObj.coverUrl || "https://via.placeholder.com/64?text=‚ô™";

      card.innerHTML = `
        <img src="${coverSrc}" class="cover" alt="Capa do √°lbum">
        <div class="music-info">
          <span class="music-title">${trackObj.title}</span>
          <span class="music-artist">${trackObj.artists}</span>
        </div>
        <button class="btn-add">‚ûï</button>
      `;

      card.querySelector(".btn-add").onclick = () => openConfirmModal(trackObj);

      resultadosDiv.appendChild(card);
    });
  }

  // ==========================
  //   MODAL DE CONFIRMA√á√ÉO
  // ==========================
  function openConfirmModal(track) {
    selectedTrack = track;
    document.getElementById("modal-desc").textContent =
      `Deseja pedir "${track.title}" de ${track.artists}?`;

    document.getElementById("confirm-modal").classList.remove("hidden");
  }

  function closeModal() {
    document.getElementById("confirm-modal").classList.add("hidden");
    selectedTrack = null;
  }

  async function sendMusicRequest() {
    if (!selectedTrack) return;

    if (!mesaId || !nomeCliente) {
      alert("Sess√£o inv√°lida. Volte para o login e entre novamente.");
      return;
    }

    try {
      const payload = {
        spotifyId: selectedTrack.spotifyId,
        spotifyUri: selectedTrack.spotifyUri,
        title: selectedTrack.title,
        artists: selectedTrack.artists,
        album: selectedTrack.album,
        coverUrl: selectedTrack.coverUrl,
        mesaId,
        clienteNome: nomeCliente,
      };

      const res = await fetch("/api/pedido-musica/queue", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const errText = await res.text().catch(() => "");
        console.error("Erro ao enviar pedido:", errText);
        alert("Erro ao enviar pedido");
        return;
      }

      alert("üéµ M√∫sica adicionada √† fila!");
    } catch (err) {
      console.error("Erro ao enviar pedido:", err);
      alert("Erro ao enviar pedido");
    }

    closeModal();
  }

  document.getElementById("btnConfirm").onclick = sendMusicRequest;

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      buscar();
    }
  });

  const params = new URLSearchParams(window.location.search);
  const query = params.get("q");
  if (query) {
    input.value = query;
    buscar();
  }
</script>
