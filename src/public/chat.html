<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Chat da Hamburgueria</title>
    <!-- MUITO IMPORTANTE PARA CELULAR -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #020617;
        color: #e5e7eb;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: #020617;
        border-bottom: 1px solid #1f2937;
      }

      #backButton {
        padding: 6px 10px;
        border-radius: 999px;
        border: none;
        background: #374151;
        color: #e5e7eb;
        cursor: pointer;
        font-size: 14px;
      }

      #backButton:hover {
        background: #4b5563;
      }

      header h1 {
        font-size: 16px;
        margin: 0;
      }

      header small {
        display: block;
        font-size: 12px;
        color: #9ca3af;
      }

      #info {
        font-size: 12px;
        color: #9ca3af;
      }

      #status {
        font-size: 12px;
        margin-top: 2px;
      }

      main {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 8px 12px 12px;
        gap: 8px;
      }

      #chat {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        border-radius: 16px;
        background: #020617;
        border: 1px solid #1f2937;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      /* Linha de mensagem */
      .msg-row {
        display: flex;
        align-items: flex-end;
        gap: 6px;
      }

      .msg-row.me {
        justify-content: flex-end;
      }

      .msg-row.other {
        justify-content: flex-start;
      }

      .msg-row.system {
        justify-content: center;
      }

      .msg-avatar {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: #4b5563;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 600;
        color: #e5e7eb;
        flex-shrink: 0;
      }

      .msg-bubble {
        max-width: 90%; 
        border-radius: 16px;
        padding: 8px 12px;
        display: flex;
        flex-direction: column;
        gap: 2px;
        font-size: 14px;
        line-height: 1.35;
      }

      .msg-row.me .msg-bubble {
        background: #22c55e;
        color: #022c22;
      }

      .msg-row.other .msg-bubble {
        background: #1f2937;
      }

      .msg-row.system .msg-bubble {
        background: transparent;
        color: #9ca3af;
        font-size: 12px;
      }

      .msg-user {
        font-size: 11px;
        font-weight: 600;
        color: #e5e7eb;
      }

      .msg-text {
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .msg-time {
        font-size: 10px;
        color: #9ca3af;
        align-self: flex-end;
      }

      /* ===== ÁREA DE DIGITAÇÃO ESTILO APP ===== */
      .input-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 6px;
        padding: 8px 10px;
        background: #020617;
        border-radius: 999px;
        border: 1px solid #1f2937;
      }

      #msgInput {
        flex: 1;
        padding: 12px 14px;      
        border-radius: 999px;
        border: none;
        background: #020617;
        color: #e5e7eb;
        font-size: 15px;         
      }

      #msgInput::placeholder {
        color: #6b7280;
      }

      #msgInput:focus {
        outline: none;
      }

      #sendBtn {
        padding: 12px 18px;       
        border-radius: 999px;
        border: none;
        background: #22c55e;
        color: #022c22;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
      }

      #sendBtn:disabled {
        opacity: 0.6;
        cursor: default;
      }

      #sendBtn:hover:not(:disabled) {
        background: #16a34a;
      }

      /* ===== AJUSTES ESPECÍFICOS PARA CELULAR ===== */
      @media (max-width: 768px) {
        header {
          padding: 10px 12px;
        }

        main {
          padding: 8px 8px 10px;
          gap: 6px;
        }

        #chat {
          padding: 8px;
          border-radius: 12px;
        }

        .msg-bubble {
          max-width: 95%;
          font-size: 15px;
          padding: 8px 12px;
        }

        .msg-row.me .msg-bubble {
          margin-left: 30px; /* espaço pro avatar */
        }

        .msg-row.other .msg-bubble {
          margin-right: 30px;
        }

        .input-row {
          padding: 8px 10px;
          margin-top: 4px;
        }

        #msgInput {
          padding: 12px 14px;
          font-size: 15px;
        }

        #sendBtn {
          padding: 10px 16px;
          font-size: 14px;
        }
      }

      /* Safe area pra iPhone (não colar no gesto de voltar) */
      @supports (padding: env(safe-area-inset-bottom)) {
        main {
          padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }
      }
    </style>
  </head>

  <body>
    <header>
      <button id="backButton">Voltar</button>
      <div>
        <h1>Chat com o Atendente</h1>
        <small id="info"></small>
        <small id="status"></small>
      </div>
    </header>

    <main>
      <!-- Janela de mensagens -->
      <div id="chat"></div>

      <!-- Campo de envio -->
      <div class="input-row">
        <input
          id="msgInput"
          type="text"
          placeholder="Digite sua mensagem e aperte Enter..."
          autocomplete="off"
        />
        <button id="sendBtn">Enviar</button>
      </div>
    </main>

    <!-- Som de nova mensagem -->
    <audio id="msgSound" src="/sons/notificacao.mp3" preload="auto"></audio>

    <!-- SCRIPT DO CHAT  -->
    <script>
      // ====== ELEMENTOS DA PÁGINA ======
      const chat = document.getElementById("chat");
      const msgInput = document.getElementById("msgInput");
      const sendBtn = document.getElementById("sendBtn");
      const statusEl = document.getElementById("status");
      const infoEl = document.getElementById("info");
      const backButton = document.getElementById("backButton");
      const msgSound = document.getElementById("msgSound");

      // ====== VOLTAR PARA O INÍCIO ======
      backButton.addEventListener("click", () => {
        window.location.href = "/inicio.html";
      });

      // ====== RECUPERA SESSION DA ABA ======
      const sessionId = sessionStorage.getItem("sessionId");
      const mesaId = sessionStorage.getItem("mesaId");
      const nomeCliente = sessionStorage.getItem("nomeCliente");

      // Se não existir, voltar ao login
      if (!sessionId || !mesaId || !nomeCliente) {
        alert("Sessão expirada ou ausente. Faça login novamente.");
        window.location.href = "/login.html";
      }

      // Nome que aparece no chat (inclui mesa)
      const myDisplayName =
        mesaId && mesaId !== "null" && mesaId !== "undefined"
          ? `${nomeCliente} (mesa ${mesaId})`
          : nomeCliente;

      // Exibe informações abaixo do título
      infoEl.textContent = `Você é "${nomeCliente}", mesa ${mesaId}.`;

      // ====== MONTA URL DO WEBSOCKET ======
      const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
      const wsHost = window.location.host;

      const wsUrl =
        `${wsProtocol}://${wsHost}/chat` +
        `?sessionId=${encodeURIComponent(sessionId)}` +
        `&mesaId=${encodeURIComponent(mesaId)}` +
        `&nome=${encodeURIComponent(nomeCliente)}`;

      // Abre o WebSocket
      const socket = new WebSocket(wsUrl);

      // ====== EVENTOS DO WEBSOCKET ======
      socket.onopen = () => {
        statusEl.textContent = "Conectado ao chat.";
      };

      socket.onerror = () => {
        statusEl.textContent = "Erro ao conectar ao chat.";
      };

      socket.onclose = () => {
        statusEl.textContent = "Conexão encerrada.";
        sendBtn.disabled = true;
        msgInput.disabled = true;
      };

      // ====== FUNÇÕES AUXILIARES ======

      // Remove “(mesa X)” para usar só o nome nas iniciais
      function extractNameFromUserField(userField) {
        const idx = userField.indexOf(" (mesa");
        if (idx === -1) return userField;
        return userField.slice(0, idx);
      }

      // Gera iniciais (avatar)
      function getInitials(name) {
        const parts = name
          .trim()
          .split(/\s+/)
          .filter(Boolean);
        if (parts.length === 0) return "?";
        if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
        return (
          parts[0].charAt(0).toUpperCase() +
          parts[parts.length - 1].charAt(0).toUpperCase()
        );
      }

      // Renderiza mensagem no chat
      function addMessageToChat(data) {
        const isSystem = data.user === "Sistema";
        const isMe = data.user === myDisplayName;

        const row = document.createElement("div");
        row.classList.add("msg-row");

        if (isSystem) row.classList.add("system");
        else if (isMe) row.classList.add("me");
        else row.classList.add("other");

        const bubble = document.createElement("div");
        bubble.classList.add("msg-bubble");

        const textEl = document.createElement("div");
        textEl.classList.add("msg-text");
        textEl.textContent = data.text;

        const timeEl = document.createElement("div");
        timeEl.classList.add("msg-time");
        timeEl.textContent = new Date(data.ts).toLocaleTimeString("pt-BR", {
          hour: "2-digit",
          minute: "2-digit",
        });

        if (isSystem) {
          bubble.appendChild(textEl);
          row.appendChild(bubble);
        } else {
          const userEl = document.createElement("div");
          userEl.classList.add("msg-user");
          userEl.textContent = data.user;

          bubble.appendChild(userEl);
          bubble.appendChild(textEl);
          bubble.appendChild(timeEl);

          const avatar = document.createElement("div");
          avatar.classList.add("msg-avatar");
          avatar.textContent = getInitials(
            extractNameFromUserField(data.user)
          );

          if (isMe) {
            row.appendChild(bubble);
            row.appendChild(avatar);
          } else {
            row.appendChild(avatar);
            row.appendChild(bubble);
          }
        }

        chat.appendChild(row);
        chat.scrollTop = chat.scrollHeight;

        // Som quando mensagem vem de outro usuário
        if (!isSystem && !isMe && msgSound) {
          try {
            msgSound.currentTime = 0;
            msgSound.play().catch(() => {});
          } catch {}
        }
      }

      // Recebe mensagem do servidor
      socket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          addMessageToChat(data);
        } catch (err) {
          console.error("Mensagem inválida:", err);
        }
      };

      // Envia mensagem para o servidor
      function enviarMensagem() {
        const texto = msgInput.value.trim();
        if (!texto) return;

        if (socket.readyState !== WebSocket.OPEN) {
          alert("Conexão com o chat está fechada.");
          return;
        }

        socket.send(JSON.stringify({ text: texto }));
        msgInput.value = "";
      }

      sendBtn.onclick = enviarMensagem;

      msgInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          enviarMensagem();
        }
      });
    </script>
  </body>
</html>
